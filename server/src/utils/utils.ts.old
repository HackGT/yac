

export function isUserConfirmed(uuid: string) {

        const query = `
                query($search: String!) {
                    search_user(search: $search, offset: 0, n: 1) {
                        users {
                            confirmed
                        }
                    }
                }
            `;

        const variables = {
            search: profile.email
        };

         const res = await fetch(process.env.GRAPHQL_URL || "https://registration.hack.gt/graphql", {
             method: 'POST',
             headers: {
                 "Authorization": "Bearer " + (process.env.GRAPHQL_AUTH || "secret"),
                 "Content-Type": "application/json",
             },
             body: JSON.stringify({
                 query,
                 variables
             })
         });

         const data = await res.json();

         if (!data || data.data.search_user.users.length === 0 || !data.data.search_user.users[0].confirmed) {
             done(new Error("User is not confirmed in registration"), undefined);
         }

        let user = await User.findOne({ uuid: profile.uuid });

        if (!user) {
            user = createNew<IUser>(User, {
                ...profile,
                admin: false
            });
        } else {
            user.token = accessToken;
        }

        await user.save();
        done(null, user);
    }


